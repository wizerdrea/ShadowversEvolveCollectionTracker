<UserControl x:Class="ShadowverseEvolveCardTracker.Views.DeckBuilderTabView"
             x:Name="Root"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:conv="clr-namespace:ShadowverseEvolveCardTracker.Converters"
             xmlns:local="clr-namespace:ShadowverseEvolveCardTracker.Views"
             xmlns:controls="clr-namespace:ShadowverseEvolveCardTracker.Controls"
             Background="{DynamicResource PrimaryBrush}">

    <UserControl.Resources>
        <conv:StringToImageSourceConverter x:Key="StringToImageConverter" />
        <conv:ClassToPackImageConverter x:Key="ClassIconConverter" />
        <BooleanToVisibilityConverter x:Key="BoolToVisConverter" />
        <conv:InverseBooleanToVisibilityConverter x:Key="InverseBoolToVisConverter" />
        <conv:CardInDeckQuantityConverter x:Key="CardInDeckQuantityConverter" />
        <conv:RarityAbbreviationConverter x:Key="RarityAbbreviationConverter" />
        <conv:SetNameExtractorConverter x:Key="SetNameExtractorConverter" />

        <!-- Custom Expander style: circular hollow chevron on the left, header to the right.
             Chevron is hollow (stroke only, no base), points down when collapsed and up when expanded.
             Circle highlights on hover. Uses application brushes. -->
        <Style x:Key="AppExpanderStyle" TargetType="Expander">
            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Expander">
                        <Border Background="Transparent">
                            <StackPanel>
                                <!-- Header toggle with circular chevron -->
                                <ToggleButton x:Name="HeaderToggle"
                                              IsChecked="{Binding IsExpanded, RelativeSource={RelativeSource TemplatedParent}, Mode=TwoWay}"
                                              Cursor="Hand"
                                              Focusable="False"
                                              Background="Transparent"
                                              BorderBrush="Transparent"
                                              Padding="4"
                                              HorizontalAlignment="Left"
                                              HorizontalContentAlignment="Left">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Circular hollow chevron (outline, no base) -->
                                        <Path x:Name="ArrowPath" Data="M0,0 L8,0 L4,5 Z" Fill="{StaticResource TextPrimaryBrush}" VerticalAlignment="Center" Width="8" Height="5" RenderTransformOrigin="0.5,0.5">
                                            <Path.RenderTransform>
                                                <RotateTransform Angle="180"/>
                                            </Path.RenderTransform>
                                        </Path>

                                        <!-- Header content to the right of the arrow -->
                                        <ContentPresenter Grid.Column="1"
                                                          VerticalAlignment="Center"
                                                          HorizontalAlignment="Left"
                                                          ContentSource="Header"
                                                          RecognizesAccessKey="True"
                                                          Margin="4,0,8,0"/>
                                    </Grid>
                                </ToggleButton>

                                <!-- Collapsible content -->
                                <ContentPresenter x:Name="ExpandSite"
                                                  Margin="0,6,0,0"
                                                  Visibility="Collapsed"
                                                  Focusable="False"
                                                  ContentSource="Content"/>
                            </StackPanel>
                        </Border>

                        <ControlTemplate.Triggers>
                            <!-- When expanded: show content and tint stroke -->
                            <Trigger Property="IsExpanded" Value="True">
                                <Setter TargetName="ExpandSite" Property="Visibility" Value="Visible"/>
                            </Trigger>

                            <!-- When collapsed: show content only (do NOT set ArrowPath.Stroke here) -->
                            <Trigger Property="IsExpanded" Value="False">
                                <Setter TargetName="ExpandSite" Property="Visibility" Value="Collapsed"/>
                                <!-- removed: Setter TargetName="ArrowPath" Property="Stroke" -->
                            </Trigger>

                            <!-- Use Expander events to animate the rotate angle -->
                            <EventTrigger RoutedEvent="Expanded">
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetName="ArrowPath"
                                                         Storyboard.TargetProperty="(Path.RenderTransform).(RotateTransform.Angle)"
                                                         To="180" Duration="0:0:0.15"/>
                                    </Storyboard>
                                </BeginStoryboard>
                            </EventTrigger>
                            <EventTrigger RoutedEvent="Collapsed">
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetName="ArrowPath"
                                                         Storyboard.TargetProperty="(Path.RenderTransform).(RotateTransform.Angle)"
                                                         To="0" Duration="0:0:0.15"/>
                                    </Storyboard>
                                </BeginStoryboard>
                            </EventTrigger>

                            <!-- Mouse-over stroke change (placed AFTER IsExpanded triggers so it can take precedence) -->
                            <Trigger SourceName="HeaderToggle" Property="IsMouseOver" Value="True">
                                <Setter TargetName="ArrowPath" Property="Stroke" Value="{StaticResource GoldBrush}"/>
                            </Trigger>

                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.6"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ListBox styling to match app theme (Surface/Elevated/Accent/Selected colors) -->
        <Style TargetType="ListBox">
            <Setter Property="Background" Value="{StaticResource SurfaceBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="4"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
        </Style>

        <!-- Keyed ListBoxItem style (scope explicitly) to avoid designer binding error
             that originates from the system default style binding to ItemsControl.HorizontalContentAlignment -->
        <Style x:Key="DeckBuilderListBoxItemStyle" TargetType="ListBoxItem">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
            <Setter Property="Padding" Value="6,4"/>
            <Setter Property="Margin" Value="0,2,0,2"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListBoxItem">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="0"
                                CornerRadius="4"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter VerticalAlignment="Center" HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{StaticResource HoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{StaticResource SelectedBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Filter dropdown ToggleButton style (bordered, hover highlight, down arrow) -->
        <Style x:Key="FilterDropdownToggleButtonStyle" TargetType="ToggleButton">
            <Setter Property="Background" Value="{DynamicResource SurfaceBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="6,4"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="6"
                                Padding="{TemplateBinding Padding}">
                            <Grid>
                                <ContentPresenter VerticalAlignment="Center" HorizontalAlignment="Center"/>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{StaticResource ElevatedBrush}"/>
                                <Setter TargetName="Bd" Property="BorderBrush" Value="{DynamicResource AccentBrush}"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{StaticResource SelectedBrush}"/>
                                <Setter TargetName="Bd" Property="BorderBrush" Value="{DynamicResource AccentBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Bd" Property="Opacity" Value="0.6"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Shared header ContextMenu control template and MenuItem style to avoid duplication -->
        <ControlTemplate x:Key="HeaderContextMenuControlTemplate" TargetType="ContextMenu">
            <Border Background="{TemplateBinding Background}"
                    BorderBrush="{TemplateBinding BorderBrush}"
                    BorderThickness="{TemplateBinding BorderThickness}"
                    CornerRadius="6"
                    Padding="{TemplateBinding Padding}">
                <StackPanel IsItemsHost="True" />
            </Border>
        </ControlTemplate>

        <Style x:Key="HeaderContextMenuItemStyle" TargetType="MenuItem">
            <Setter Property="Background" Value="{DynamicResource SurfaceBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="MenuItem">
                        <Border Background="{TemplateBinding Background}"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter ContentSource="Header" RecognizesAccessKey="True"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Setter Property="Icon" Value="{x:Null}"/>
        </Style>

        <Style x:Key="HeaderContextMenuStyle" TargetType="ContextMenu">
            <Setter Property="Background" Value="{DynamicResource SurfaceBrush}" />
            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Padding" Value="4" />
            <Setter Property="HasDropShadow" Value="True" />
            <Setter Property="Template" Value="{StaticResource HeaderContextMenuControlTemplate}" />
            <Setter Property="ItemContainerStyle" Value="{StaticResource HeaderContextMenuItemStyle}" />
        </Style>

        <CollectionViewSource x:Key="RarityFilters" Source="{Binding RarityFilters}"/>
        <CollectionViewSource x:Key="TypeFilters" Source="{Binding TypeFilters}"/>
        <CollectionViewSource x:Key="ClassFilters" Source="{Binding ClassFilters}"/>
        <CollectionViewSource x:Key="SetFilters" Source="{Binding SetFilters}"/>

        <!-- NEW -->
        <CollectionViewSource x:Key="CostFilters" Source="{Binding CostFilters}"/>
        <CollectionViewSource x:Key="OwnedFilters" Source="{Binding OwnedFilters}"/>
        <CollectionViewSource x:Key="InDeckFilters" Source="{Binding InDeckFilters}"/>
        <CollectionViewSource x:Key="TraitsFilters" Source="{Binding TraitsFilters}"/>
    </UserControl.Resources>

    <Grid>
        <!-- Deck List View -->
        <Grid Visibility="{Binding IsEditingDeck, Converter={StaticResource InverseBoolToVisConverter}}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <StackPanel Grid.Row="0" Margin="16,16,16,8">
                <Button Content="Create New Deck" 
                        Command="{Binding CreateDeckCommand}"
                        HorizontalAlignment="Left"
                        Padding="12,6"/>
            </StackPanel>

            <TabControl Grid.Row="1" Margin="16,8,16,16">
                <!-- Standard Decks -->
                <TabItem Header="Standard">
                    <DataGrid ItemsSource="{Binding StandardDecks}"
                              AutoGenerateColumns="False"
                              SelectionMode="Single"
                              IsReadOnly="True"
                              CanUserSortColumns="True">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Deck Name" Binding="{Binding Name}" Width="*"/>
                            <DataGridTextColumn Header="Class" Binding="{Binding Class1}" Width="100"/>
                            <DataGridTemplateColumn Header="Leader" Width="80">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Image Source="{Binding Leader1.ImageFile, Converter={StaticResource StringToImageConverter}}"
                                               Height="60" Stretch="Uniform"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTemplateColumn Header="Actions" Width="150">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Button Content="Edit" 
                                                    Command="{Binding DataContext.EditDeckCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    CommandParameter="{Binding}"
                                                    Margin="0,0,4,0"/>
                                            <Button Content="Delete" 
                                                    Command="{Binding DataContext.DeleteDeckCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    CommandParameter="{Binding}"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </TabItem>

                <!-- Gloryfinder Decks -->
                <TabItem Header="Gloryfinder">
                    <DataGrid ItemsSource="{Binding GloryfinderDecks}"
                              AutoGenerateColumns="False"
                              SelectionMode="Single"
                              IsReadOnly="True">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Deck Name" Binding="{Binding Name}" Width="*"/>
                            <DataGridTextColumn Header="Class" Binding="{Binding Class1}" Width="100"/>
                            <DataGridTemplateColumn Header="Leader" Width="80">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Image Source="{Binding Leader1.ImageFile, Converter={StaticResource StringToImageConverter}}"
                                               Height="60" Stretch="Uniform"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTemplateColumn Header="Actions" Width="150">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Button Content="Edit" 
                                                    Command="{Binding DataContext.EditDeckCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    CommandParameter="{Binding}"
                                                    Margin="0,0,4,0"/>
                                            <Button Content="Delete" 
                                                    Command="{Binding DataContext.DeleteDeckCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    CommandParameter="{Binding}"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </TabItem>

                <!-- Cross Play Decks -->
                <TabItem Header="Cross Play">
                    <DataGrid ItemsSource="{Binding CrossCraftDecks}"
                              AutoGenerateColumns="False"
                              SelectionMode="Single"
                              IsReadOnly="True">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Deck Name" Binding="{Binding Name}" Width="*"/>
                            <DataGridTextColumn Header="Classes" Width="150">
                                <DataGridTextColumn.Binding>
                                    <MultiBinding StringFormat="{}{0} / {1}">
                                        <Binding Path="Class1"/>
                                        <Binding Path="Class2"/>
                                    </MultiBinding>
                                </DataGridTextColumn.Binding>
                            </DataGridTextColumn>
                            <DataGridTemplateColumn Header="Leaders" Width="120">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Image Source="{Binding Leader1.ImageFile, Converter={StaticResource StringToImageConverter}}"
                                                   Height="60" Width="50" Stretch="Uniform" Margin="0,0,4,0"/>
                                            <Image Source="{Binding Leader2.ImageFile, Converter={StaticResource StringToImageConverter}}"
                                                   Height="60" Width="50" Stretch="Uniform"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTemplateColumn Header="Actions" Width="150">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Button Content="Edit" 
                                                    Command="{Binding DataContext.EditDeckCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    CommandParameter="{Binding}"
                                                    Margin="0,0,4,0"/>
                                            <Button Content="Delete" 
                                                    Command="{Binding DataContext.DeleteDeckCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    CommandParameter="{Binding}"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </TabItem>
            </TabControl>
        </Grid>

        <!-- Deck Editor View -->
        <Grid Visibility="{Binding IsEditingDeck, Converter={StaticResource BoolToVisConverter}}">
            <Grid.ColumnDefinitions>
                <!-- Left: Available cards (star so splitters can redistribute space) -->
                <ColumnDefinition Width="6*" MinWidth="200"/>

                <!-- Splitter between Left and Center -->
                <ColumnDefinition Width="6"/>

                <!-- Center: Card viewer (star to allow resizing) -->
                <ColumnDefinition Width="2.5*" MinWidth="200"/>

                <!-- Splitter between Center and Right -->
                <ColumnDefinition Width="6"/>

                <!-- Right: Deck lists (star to allow resizing) -->
                <ColumnDefinition Width="1.75*" MinWidth="150"/>
            </Grid.ColumnDefinitions>

            <!-- Left: Available Cards -->
            <Grid Grid.Column="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/> <!-- filters row -->
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <StackPanel Grid.Row="0" Margin="8" HorizontalAlignment="Left">
                    <Button Content="← Back to Deck List" 
                            Command="{Binding BackToDeckListCommand}"
                            Margin="0,0,0,8"/>
                    <TextBlock Text="Available Cards" 
                               FontWeight="SemiBold" 
                               FontSize="14"
                               Foreground="{DynamicResource GoldBrush}"/>
                </StackPanel>

                <!-- Filters expander - now using the custom AppExpanderStyle -->
                <Expander Grid.Row="1" Margin="8,0,8,4" Header="Filters" IsExpanded="True" Style="{StaticResource AppExpanderStyle}">
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <TextBlock Text="Name" VerticalAlignment="Center" Margin="0,0,6,0"/>
                            <TextBox Width="220" 
                                     Text="{Binding NameFilter, UpdateSourceTrigger=PropertyChanged}"
                                     ToolTip="Filter cards by name using a regex (or plain text if regex invalid)"/>
                        </StackPanel>

                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <TextBlock Text="Text" VerticalAlignment="Center" Margin="12,0,6,0"/>
                            <TextBox Width="220" 
                                     Text="{Binding TextFilter, UpdateSourceTrigger=PropertyChanged}"
                                     ToolTip="Filter card text using a regex (or plain text if regex invalid)"/>
                        </StackPanel>

                        <!-- Traits dropdown (toggle + popup) -->
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="12,0,0,0">
                            <ToggleButton x:Name="TraitsToggle"
                                          Style="{StaticResource FilterDropdownToggleButtonStyle}"
                                          Width="120"
                                          HorizontalAlignment="Left"
                                          Checked="TraitsToggle_Checked"
                                          Unchecked="TraitsToggle_Unchecked">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                    <TextBlock Text="Traits" Margin="0,0,6,0" VerticalAlignment="Center" Foreground="{StaticResource TextPrimaryBrush}" />
                                    <!-- arrow path; we'll rotate it in code-behind when popup opens/closes -->
                                    <Path x:Name="TraitsArrowPath" Data="M0,0 L8,0 L4,5 Z" Fill="{StaticResource TextPrimaryBrush}" VerticalAlignment="Center" Width="8" Height="5" RenderTransformOrigin="0.5,0.5">
                                        <Path.RenderTransform>
                                            <RotateTransform Angle="0"/>
                                        </Path.RenderTransform>
                                    </Path>
                                </StackPanel>
                            </ToggleButton>

                            <Popup x:Name="TraitsPopup"
                                   Placement="Bottom"
                                   PlacementTarget="{Binding ElementName=TraitsToggle}"
                                   StaysOpen="False"
                                   AllowsTransparency="True"
                                   PopupAnimation="Fade"
                                   Closed="TraitsPopup_Closed">
                                <Border Background="{DynamicResource SurfaceBrush}" Padding="6" CornerRadius="6" BorderBrush="{StaticResource BorderBrush}" BorderThickness="1" Width="280">
                                    <StackPanel>
                                        <TextBlock Text="Select Traits (multi-select)" FontWeight="SemiBold" Margin="0,0,0,6"/>
                                        <ScrollViewer Height="180" VerticalScrollBarVisibility="Auto">
                                            <ItemsControl ItemsSource="{Binding TraitsFilters}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <CheckBox Content="{Binding Name}" IsChecked="{Binding IsChecked, Mode=TwoWay}" Padding="4,2"/>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>

                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,8,0,0">
                                            <!-- Buttons keep their names; code-behind wires click handlers -->
                                            <Button x:Name="SelectAllTraitsButton" Content="Select All" Margin="0,0,6,0"/>
                                            <Button x:Name="ClearAllTraitsButton" Content="Clear All"/>
                                        </StackPanel>
                                    </StackPanel>
                                </Border>
                            </Popup>
                        </StackPanel>
                    </StackPanel>
                </Expander>

                <DataGrid x:Name="AvailableCardsGrid"
                          Grid.Row="2" 
                          ItemsSource="{Binding ValidCards}"
                          SelectedItem="{Binding SelectedCard}"
                          AutoGenerateColumns="False"
                          SelectionMode="Single"
                          IsReadOnly="True"
                          SelectionChanged="AvailableCardsGrid_SelectionChanged"
                          Margin="8,0,8,8">

                    <DataGrid.RowStyle>
                        <Style TargetType="DataGridRow" BasedOn="{StaticResource {x:Type DataGridRow}}">
                            <Setter Property="ToolTip">
                                <Setter.Value>
                                    <ToolTip Placement="Mouse" Background="Transparent" BorderThickness="0" Padding="0" HasDropShadow="False">
                                        <Border Background="transparent" 
                                                Padding="0" 
                                                CornerRadius="4" 
                                                BorderBrush="Transparent" 
                                                BorderThickness="0">
                                            <Image Source="{Binding ImageFile, Converter={StaticResource StringToImageConverter}}"
                                                   Width="240" Height="320" Stretch="Uniform"/>
                                        </Border>
                                    </ToolTip>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </DataGrid.RowStyle>

                    <DataGrid.Columns>
                        <!-- Favorite star column (far left) with header toggle — copied from AllCardsTabView.xaml -->
                        <DataGridTemplateColumn Width="40" IsReadOnly="False">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <ToggleButton IsChecked="{Binding IsFavorite, Mode=TwoWay}"
                                                  Click="CardFavoriteToggle_Click"
                                                  Cursor="Hand"
                                                  Focusable="False"
                                                  HorizontalAlignment="Center"
                                                  VerticalAlignment="Center">
                                        <ToggleButton.Template>
                                            <ControlTemplate TargetType="ToggleButton">
                                                <Border Background="{TemplateBinding Background}"
                                                        BorderBrush="{TemplateBinding BorderBrush}"
                                                        BorderThickness="{TemplateBinding BorderThickness}">
                                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                </Border>
                                            </ControlTemplate>
                                        </ToggleButton.Template>
                                        <ToggleButton.ToolTip>
                                            <ToolTip Placement="Mouse" Background="Transparent" BorderThickness="0" Padding="0" HasDropShadow="False">
                                                <Border Background="{DynamicResource ElevatedBrush}"
                                                        Padding="6"
                                                        CornerRadius="4"
                                                        BorderBrush="{DynamicResource AccentBrush}"
                                                        BorderThickness="1">
                                                    <TextBlock Text="Toggle favorite"
                                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                </Border>
                                            </ToolTip>
                                        </ToggleButton.ToolTip>

                                        <Viewbox Width="18" Height="18">
                                            <Canvas Width="24" Height="24">
                                                <!-- Filled star when checked -->
                                                <Path Fill="{DynamicResource GoldBrush}"
                                                      Data="M12,17.27 L18.18,21 L16.54,13.97 L22,9.24 L14.81,8.63 L12,2 L9.19,8.63 L2,9.24 L7.46,13.97 L5.82,21 z"
                                                      Visibility="{Binding IsChecked, RelativeSource={RelativeSource AncestorType=ToggleButton}, Converter={StaticResource BoolToVisConverter}}"/>
                                                <!-- Outline star when unchecked -->
                                                <Path Stroke="{DynamicResource GoldBrush}"
                                                      Fill="Transparent"
                                                      StrokeThickness="1.6"
                                                      Data="M12,17.27 L18.18,21 L16.54,13.97 L22,9.24 L14.81,8.63 L12,2 L9.19,8.63 L2,9.24 L7.46,13.97 L5.82,21 z"
                                                      Visibility="Visible"/>
                                            </Canvas>
                                        </Viewbox>
                                    </ToggleButton>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>

                            <DataGridTemplateColumn.HeaderTemplate>
                                <DataTemplate>
                                    <!-- Header toggle: binds to outer DataContext.FavoritesOnly -->
                                    <ToggleButton Cursor="Hand"
                                                  Focusable="False"
                                                  HorizontalAlignment="Center"
                                                  VerticalAlignment="Center"
                                                  IsChecked="{Binding DataContext.FavoritesOnly, RelativeSource={RelativeSource AncestorType=UserControl}, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                        <ToggleButton.Template>
                                            <ControlTemplate TargetType="ToggleButton">
                                                <Border Background="{TemplateBinding Background}"
                                                        BorderBrush="{TemplateBinding BorderBrush}"
                                                        BorderThickness="{TemplateBinding BorderThickness}">
                                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                </Border>
                                            </ControlTemplate>
                                        </ToggleButton.Template>

                                        <ToggleButton.ToolTip>
                                            <ToolTip Placement="Mouse" Background="Transparent" BorderThickness="0" Padding="0" HasDropShadow="False">
                                                <Border Background="{DynamicResource ElevatedBrush}"
                                                        Padding="6"
                                                        CornerRadius="4"
                                                        BorderBrush="{DynamicResource AccentBrush}"
                                                        BorderThickness="1">
                                                    <TextBlock Text="Show favorites only"
                                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                </Border>
                                            </ToolTip>
                                        </ToggleButton.ToolTip>

                                        <Viewbox Width="18" Height="18">
                                            <Canvas Width="24" Height="24">
                                                <!-- Filled star when header is checked -->
                                                <Path Fill="{DynamicResource GoldBrush}"
                                                      Data="M12,17.27 L18.18,21 L16.54,13.97 L22,9.24 L14.81,8.63 L12,2 L9.19,8.63 L2,9.24 L7.46,13.97 L5.82,21 z"
                                                      Visibility="{Binding IsChecked, RelativeSource={RelativeSource AncestorType=ToggleButton}, Converter={StaticResource BoolToVisConverter}}"/>
                                                <!-- Outline star when header isunchecked -->
                                                <Path Stroke="{DynamicResource GoldBrush}"
                                                      Fill="Transparent"
                                                      StrokeThickness="1.6"
                                                      Data="M12,17.27 L18.18,21 L16.54,13.97 L22,9.24 L14.81,8.63 L12,2 L9.19,8.63 L2,9.24 L7.46,13.97 L5.82,21 z"
                                                      Visibility="Visible"/>
                                            </Canvas>
                                        </Viewbox>
                                    </ToggleButton>
                                </DataTemplate>
                            </DataGridTemplateColumn.HeaderTemplate>
                        </DataGridTemplateColumn>

                        <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="*"/>
                        <DataGridTextColumn Header="Cost" Binding="{Binding Cost}" Width="45">
                            <DataGridTextColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <!-- Make the header background/foreground/padding match other headers -->
                                    <Setter Property="Background" Value="{DynamicResource HeaderGradientBrush}" />
                                    <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                                    <Setter Property="Foreground" Value="{StaticResource GoldBrush}"/>
                                    <Setter Property="Padding" Value="8,8"/>
                                    <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
                                    <Setter Property="BorderThickness" Value="0,0,1,1"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                    <Setter Property="HorizontalContentAlignment" Value="Left"/>

                                    <Setter Property="ContextMenu">
                                        <Setter.Value>
                                            <ContextMenu Style="{StaticResource HeaderContextMenuStyle}">
                                                <ContextMenu.ItemsSource>
                                                    <CompositeCollection>
                                                        <CollectionContainer Collection="{Binding Source={StaticResource CostFilters}}"/>
                                                        <MenuItem Header="Select All"
                                                                  Command="{Binding SelectAllCostFiltersCommand}"/>
                                                        <MenuItem Header="Clear All"
                                                                  Command="{Binding ClearAllCostFiltersCommand}"/>
                                                    </CompositeCollection>
                                                </ContextMenu.ItemsSource>

                                                <ContextMenu.ItemTemplate>
                                                    <DataTemplate>
                                                        <!-- Use a CheckBox as the content; make its background transparent so the context surface shows through -->
                                                        <CheckBox VerticalAlignment="Center" HorizontalAlignment="Left" OverridesDefaultStyle="False"
                                                                  BorderThickness="0"
                                                                  Content="{Binding Name}"
                                                                  IsChecked="{Binding IsChecked, Mode=TwoWay}"
                                                                  Padding="6,4"/>
                                                    </DataTemplate>
                                                </ContextMenu.ItemTemplate>
                                            </ContextMenu>
                                        </Setter.Value>
                                    </Setter>

                                    <Setter Property="ContentTemplate">
                                        <Setter.Value>
                                            <DataTemplate>
                                                <TextBlock Text="Cost" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </DataTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </DataGridTextColumn.HeaderStyle>
                        </DataGridTextColumn>

                        <!-- UPDATED: Rarity column now contains the rarity filters directly in the header context menu -->
                        <DataGridTextColumn Width="45"
                                             Binding="{Binding Rarity, Converter={StaticResource RarityAbbreviationConverter}}">
                            <DataGridTextColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <!-- Make the header background/foreground/padding match other headers -->
                                    <Setter Property="Background" Value="{DynamicResource HeaderGradientBrush}" />
                                    <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                                    <Setter Property="Foreground" Value="{StaticResource GoldBrush}"/>
                                    <Setter Property="Padding" Value="8,8"/>
                                    <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
                                    <Setter Property="BorderThickness" Value="0,0,1,1"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                    <Setter Property="HorizontalContentAlignment" Value="Left"/>

                                    <Setter Property="ContextMenu">
                                        <Setter.Value>
                                            <ContextMenu Style="{StaticResource HeaderContextMenuStyle}">
                                                <ContextMenu.ItemsSource>
                                                    <CompositeCollection>
                                                        <CollectionContainer Collection="{Binding Source={StaticResource RarityFilters}}"/>
                                                        <!--<Separator/>-->
                                                        <MenuItem Header="Select All"
                                                                  Command="{Binding SelectAllRarityFiltersCommand}"/>
                                                        <MenuItem Header="Clear All"
                                                                  Command="{Binding ClearAllRarityFiltersCommand}"/>
                                                    </CompositeCollection>
                                                </ContextMenu.ItemsSource>

                                                <ContextMenu.ItemTemplate>
                                                    <DataTemplate>
                                                        <!-- Use a CheckBox as the content; make its background transparent so the context surface shows through -->
                                                        <CheckBox VerticalAlignment="Center" HorizontalAlignment="Left" OverridesDefaultStyle="False"
                                                                  BorderThickness="0"
                                                                  Content="{Binding Name}"
                                                                  IsChecked="{Binding IsChecked, Mode=TwoWay}"
                                                                  Padding="6,4"/>
                                                    </DataTemplate>
                                                </ContextMenu.ItemTemplate>
                                            </ContextMenu>
                                        </Setter.Value>
                                    </Setter>

                                    <Setter Property="ContentTemplate">
                                        <Setter.Value>
                                            <DataTemplate>
                                                <TextBlock Text="Rarity" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </DataTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </DataGridTextColumn.HeaderStyle>
                        </DataGridTextColumn>

                        <DataGridTextColumn Width="75"
                                             Binding="{Binding Type}">
                            <DataGridTextColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <!-- Make the header background/foreground/padding match other headers -->
                                    <Setter Property="Background" Value="{DynamicResource HeaderGradientBrush}" />
                                    <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                                    <Setter Property="Foreground" Value="{StaticResource GoldBrush}"/>
                                    <Setter Property="Padding" Value="8,8"/>
                                    <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
                                    <Setter Property="BorderThickness" Value="0,0,1,1"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                    <Setter Property="HorizontalContentAlignment" Value="Left"/>

                                    <Setter Property="ContextMenu">
                                        <Setter.Value>
                                            <ContextMenu Style="{StaticResource HeaderContextMenuStyle}">
                                                <ContextMenu.ItemsSource>
                                                    <CompositeCollection>
                                                        <CollectionContainer Collection="{Binding Source={StaticResource TypeFilters}}"/>
                                                        <!--<Separator/>-->
                                                        <MenuItem Header="Select All"
                                                                  Command="{Binding SelectAllTypeFiltersCommand}"/>
                                                        <MenuItem Header="Clear All"
                                                                  Command="{Binding ClearAllTypeFiltersCommand}"/>
                                                    </CompositeCollection>
                                                </ContextMenu.ItemsSource>

                                                <ContextMenu.ItemTemplate>
                                                    <DataTemplate>
                                                        <!-- Use a CheckBox as the content; make its background transparent so the context surface shows through -->
                                                        <CheckBox VerticalAlignment="Center" HorizontalAlignment="Left" OverridesDefaultStyle="False"
                                                                  BorderThickness="0"
                                                                  Content="{Binding Name}"
                                                                  IsChecked="{Binding IsChecked, Mode=TwoWay}"
                                                                  Padding="6,4"/>
                                                    </DataTemplate>
                                                </ContextMenu.ItemTemplate>
                                            </ContextMenu>
                                        </Setter.Value>
                                    </Setter>

                                    <Setter Property="ContentTemplate">
                                        <Setter.Value>
                                            <DataTemplate>
                                                <TextBlock Text="Type" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </DataTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </DataGridTextColumn.HeaderStyle>
                        </DataGridTextColumn>

                        <!-- New: Class icon column (between Rarity and Set) -->
                        <DataGridTemplateColumn Header="Class" Width="45">
                            <DataGridTemplateColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="Background" Value="{DynamicResource HeaderGradientBrush}" />
                                    <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                                    <Setter Property="Foreground" Value="{StaticResource GoldBrush}"/>
                                    <Setter Property="Padding" Value="8,8"/>
                                    <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
                                    <Setter Property="BorderThickness" Value="0,0,1,1"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                    <Setter Property="HorizontalContentAlignment" Value="Left"/>

                                    <Setter Property="ContextMenu">
                                        <Setter.Value>
                                            <ContextMenu Style="{StaticResource HeaderContextMenuStyle}">
                                                <ContextMenu.ItemsSource>
                                                    <CompositeCollection>
                                                        <CollectionContainer Collection="{Binding Source={StaticResource ClassFilters}}"/>
                                                        <!--<Separator/>-->
                                                        <MenuItem Header="Select All"
                                                                  Command="{Binding SelectAllClassFiltersCommand}"/>
                                                        <MenuItem Header="Clear All"
                                                                  Command="{Binding ClearAllClassFiltersCommand}"/>
                                                    </CompositeCollection>
                                                </ContextMenu.ItemsSource>

                                                <ContextMenu.ItemTemplate>
                                                    <DataTemplate>
                                                        <!-- Use a CheckBox as the content; make its background transparent so the context surface shows through -->
                                                        <CheckBox VerticalAlignment="Center" HorizontalAlignment="Left" OverridesDefaultStyle="False"
                                                                  BorderThickness="0"
                                                                  Content="{Binding Name}"
                                                                  IsChecked="{Binding IsChecked, Mode=TwoWay}"
                                                                  Padding="6,4"/>
                                                    </DataTemplate>
                                                </ContextMenu.ItemTemplate>
                                            </ContextMenu>
                                        </Setter.Value>
                                    </Setter>

                                    <Setter Property="ContentTemplate">
                                        <Setter.Value>
                                            <DataTemplate>
                                                <TextBlock Text="Class" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </DataTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </DataGridTemplateColumn.HeaderStyle>

                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Border Background="Transparent" Padding="2" HorizontalAlignment="Center" VerticalAlignment="Center">
                                        <Image Source="{Binding Class, Converter={StaticResource ClassIconConverter}}"
                                               Height="20" Stretch="Uniform" HorizontalAlignment="Center">
                                            <Image.ToolTip>
                                                <ToolTip Placement="Mouse" Background="Transparent" BorderThickness="0" Padding="0" HasDropShadow="False">
                                                    <Border Background="{DynamicResource ElevatedBrush}"
                                                            Padding="6"
                                                            CornerRadius="4"
                                                            BorderBrush="{DynamicResource AccentBrush}"
                                                            BorderThickness="1">
                                                        <TextBlock Text="{Binding Class}"
                                                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                    </Border>
                                                </ToolTip>
                                            </Image.ToolTip>
                                            
                                        </Image>
                                    </Border>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <!-- Set column now has a header context menu with SetFilters -->
                        <DataGridTextColumn Header="Set" Binding="{Binding Set, Converter={StaticResource SetNameExtractorConverter}}" Width="120">
                            <DataGridTextColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="Background" Value="{DynamicResource HeaderGradientBrush}" />
                                    <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                                    <Setter Property="Foreground" Value="{StaticResource GoldBrush}"/>
                                    <Setter Property="Padding" Value="8,8"/>
                                    <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
                                    <Setter Property="BorderThickness" Value="0,0,1,1"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                    <Setter Property="HorizontalContentAlignment" Value="Left"/>

                                    <Setter Property="ContextMenu">
                                        <Setter.Value>
                                            <ContextMenu Style="{StaticResource HeaderContextMenuStyle}">
                                                <ContextMenu.ItemsSource>
                                                    <CompositeCollection>
                                                        <CollectionContainer Collection="{Binding Source={StaticResource SetFilters}}"/>
                                                        <!--<Separator/>-->
                                                        <MenuItem Header="Select All"
                                                                  Command="{Binding SelectAllSetFiltersCommand}"/>
                                                        <MenuItem Header="Clear All"
                                                                  Command="{Binding ClearAllSetFiltersCommand}"/>
                                                    </CompositeCollection>
                                                </ContextMenu.ItemsSource>

                                                <ContextMenu.ItemTemplate>
                                                    <DataTemplate>
                                                        <!-- Use a CheckBox as the content; make its background transparent so the context surface shows through -->
                                                        <CheckBox VerticalAlignment="Center" HorizontalAlignment="Left" OverridesDefaultStyle="False"
                                                                  BorderThickness="0"
                                                                  Content="{Binding Name}"
                                                                  IsChecked="{Binding IsChecked, Mode=TwoWay}"
                                                                  Padding="6,4"/>
                                                    </DataTemplate>
                                                </ContextMenu.ItemTemplate>
                                            </ContextMenu>
                                        </Setter.Value>
                                    </Setter>

                                    <Setter Property="ContentTemplate">
                                        <Setter.Value>
                                            <DataTemplate>
                                                <TextBlock Text="Set" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </DataTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </DataGridTextColumn.HeaderStyle>
                        </DataGridTextColumn>

                        <DataGridTextColumn Header="# Owned" Binding="{Binding QuantityOwned}" Width="65" >
        <DataGridTextColumn.HeaderStyle>
            <Style TargetType="DataGridColumnHeader">
                <Setter Property="Background" Value="{DynamicResource HeaderGradientBrush}" />
                <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                <Setter Property="Foreground" Value="{StaticResource GoldBrush}"/>
                <Setter Property="Padding" Value="8,8"/>
                <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
                <Setter Property="BorderThickness" Value="0,0,1,1"/>
                <Setter Property="FontWeight" Value="SemiBold"/>
                <Setter Property="HorizontalContentAlignment" Value="Left"/>

                <Setter Property="ContextMenu">
                    <Setter.Value>
                        <ContextMenu Style="{StaticResource HeaderContextMenuStyle}">
                            <ContextMenu.ItemsSource>
                                <CompositeCollection>
                                    <CollectionContainer Collection="{Binding Source={StaticResource OwnedFilters}}"/>
                                    <MenuItem Header="Select All"
                                              Command="{Binding SelectAllOwnedFiltersCommand}"/>
                                    <MenuItem Header="Clear All"
                                              Command="{Binding ClearAllOwnedFiltersCommand}"/>
                                </CompositeCollection>
                            </ContextMenu.ItemsSource>

                            <ContextMenu.ItemTemplate>
                                <DataTemplate>
                                    <CheckBox VerticalAlignment="Center" HorizontalAlignment="Left" OverridesDefaultStyle="False"
                                              BorderThickness="0"
                                              Content="{Binding Name}"
                                              IsChecked="{Binding IsChecked, Mode=TwoWay}"
                                              Padding="6,4"/>
                                </DataTemplate>
                            </ContextMenu.ItemTemplate>
                        </ContextMenu>
                    </Setter.Value>
                </Setter>

                <Setter Property="ContentTemplate">
                    <Setter.Value>
                        <DataTemplate>
                            <TextBlock Text="# Owned" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </DataTemplate>
                    </Setter.Value>
                </Setter>
            </Style>
        </DataGridTextColumn.HeaderStyle>
    </DataGridTextColumn>

                        <!-- In-Deck column now has a header context menu for quantity filters -->
                        <DataGridTemplateColumn Header="In Deck" Width="120">
                            <DataGridTemplateColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="Background" Value="{DynamicResource HeaderGradientBrush}" />
                                    <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                                    <Setter Property="Foreground" Value="{StaticResource GoldBrush}"/>
                                    <Setter Property="Padding" Value="8,8"/>
                                    <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
                                    <Setter Property="BorderThickness" Value="0,0,1,1"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                    <Setter Property="HorizontalContentAlignment" Value="Left"/>

                                    <Setter Property="ContextMenu">
                                        <Setter.Value>
                                            <ContextMenu Style="{StaticResource HeaderContextMenuStyle}">
                                                <ContextMenu.ItemsSource>
                                                    <CompositeCollection>
                                                        <CollectionContainer Collection="{Binding Source={StaticResource InDeckFilters}}"/>
                                                        <MenuItem Header="Select All"
                                                                  Command="{Binding SelectAllInDeckFiltersCommand}"/>
                                                        <MenuItem Header="Clear All"
                                                                  Command="{Binding ClearAllInDeckFiltersCommand}"/>
                                                    </CompositeCollection>
                                                </ContextMenu.ItemsSource>

                                                <ContextMenu.ItemTemplate>
                                                    <DataTemplate>
                                                        <CheckBox VerticalAlignment="Center" HorizontalAlignment="Left" OverridesDefaultStyle="False"
                                                                  BorderThickness="0"
                                                                  Content="{Binding Name}"
                                                                  IsChecked="{Binding IsChecked, Mode=TwoWay}"
                                                                  Padding="6,4"/>
                                                    </DataTemplate>
                                                </ContextMenu.ItemTemplate>
                                            </ContextMenu>
                                        </Setter.Value>
                                    </Setter>

                                    <Setter Property="ContentTemplate">
                                        <Setter.Value>
                                            <DataTemplate>
                                                <TextBlock Text="In Deck" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </DataTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </DataGridTemplateColumn.HeaderStyle>

                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                        <Button Content="−"
                                                Width="26"
                                                Height="24"
                                                Padding="0"
                                                Margin="0,0,6,0"
                                                Command="{Binding DataContext.DecreaseAvailableCardCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}">
                                            <Button.ToolTip>
                                                <ToolTip Placement="Mouse" Background="Transparent" BorderThickness="0" Padding="0" HasDropShadow="False">
                                                    <Border Background="{DynamicResource ElevatedBrush}"
                                                            Padding="6"
                                                            CornerRadius="4"
                                                            BorderBrush="{DynamicResource AccentBrush}"
                                                            BorderThickness="1">
                                                        <TextBlock Text="Decrease quantity in deck"
                                                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                    </Border>
                                                </ToolTip>
                                            </Button.ToolTip>
                                        </Button>
                                        <TextBlock VerticalAlignment="Center"
                                                   Foreground="{DynamicResource GoldBrush}"
                                                   FontWeight="SemiBold"
                                                   Width="26"
                                                   TextAlignment="Center">
                                            <TextBlock.Text>
                                                <MultiBinding Converter="{StaticResource CardInDeckQuantityConverter}">
                                                    <!-- first value: the row CardData -->
                                                    <Binding />
                                                    <!-- second value: the current deck from the viewmodel -->
                                                    <Binding Path="DataContext.CurrentDeck" ElementName="Root" />
                                                    <!-- third value: deck change tick to force re-evaluation when quantities change -->
                                                    <Binding Path="DataContext.DeckChangeTick" ElementName="Root" />
                                                </MultiBinding>
                                            </TextBlock.Text>
                                        </TextBlock>
                                        <Button Content="+"
                                                Width="26"
                                                Height="24"
                                                Padding="0"
                                                Margin="6,0,0,0"
                                                Command="{Binding DataContext.IncreaseAvailableCardCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}">
                                            <Button.ToolTip>
                                                <ToolTip Placement="Mouse" Background="Transparent" BorderThickness="0" Padding="0" HasDropShadow="False">
                                                    <Border Background="{DynamicResource ElevatedBrush}"
                                                            Padding="6"
                                                            CornerRadius="4"
                                                            BorderBrush="{DynamicResource AccentBrush}"
                                                            BorderThickness="1">
                                                        <TextBlock Text="Increase quantity in deck"
                                                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                    </Border>
                                                </ToolTip>
                                            </Button.ToolTip>
                                        </Button>
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>

            <!-- GridSplitter between Left and Center -->
            <GridSplitter Grid.Column="1"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Stretch"
                          Width="6"
                          Background="{DynamicResource AccentBrush}"
                          ResizeDirection="Columns"
                          ResizeBehavior="PreviousAndNext"
                          ShowsPreview="True"
                          IsTabStop="False"/>

            <!-- Center: Card Viewer & Deck Info -->
            <Grid Grid.Column="2" Margin="8">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Deck Header -->
                <Border Grid.Row="0" 
                        Background="{DynamicResource ElevatedBrush}"
                        BorderBrush="{DynamicResource AccentBrush}"
                        BorderThickness="1"
                        Padding="12"
                        Margin="0,0,0,8">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBox Grid.Row="0" 
                                 Text="{Binding DeckName, UpdateSourceTrigger=PropertyChanged}"
                                 FontSize="18"
                                 FontWeight="SemiBold"
                                 Margin="0,0,0,8"/>

                        <StackPanel Grid.Row="1" Orientation="Horizontal">
                            <TextBlock Text="Main Deck: " Foreground="{DynamicResource TextSecondaryBrush}"/>
                            <TextBlock Text="{Binding MainDeckCount}" Foreground="{DynamicResource GoldBrush}" FontWeight="SemiBold"/>
                            <TextBlock Text=" / 50" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,0,16,0"/>

                            <TextBlock Text="Evolve Deck: " Foreground="{DynamicResource TextSecondaryBrush}"/>
                            <TextBlock Text="{Binding EvolveDeckCount}" Foreground="{DynamicResource GoldBrush}" FontWeight="SemiBold"/>
                            <TextBlock Text=" / " Foreground="{DynamicResource TextSecondaryBrush}"/>
                            <TextBlock Foreground="{DynamicResource TextSecondaryBrush}">
                                <TextBlock.Text>
                                    <Binding Path="IsGloryfinder">
                                        <Binding.Converter>
                                            <conv:BoolToStringConverter TrueValue="20" FalseValue="10"/>
                                        </Binding.Converter>
                                    </Binding>
                                </TextBlock.Text>
                            </TextBlock>

                            <TextBlock Text="✓ "
                                        Foreground="{DynamicResource GoldBrush}"
                                        FontWeight="SemiBold"
                                        Margin="12,0,0,0"
                                        Visibility="{Binding DeckIsValid, Converter={StaticResource BoolToVisConverter}}"/>

                            <TextBlock Text="✗ "
                                        Foreground="{DynamicResource TextSecondaryBrush}"
                                        FontWeight="SemiBold"
                                        Margin="12,0,0,0"
                                        Visibility="{Binding DeckIsValid, Converter={StaticResource InverseBoolToVisConverter}}"/>

                            <!-- Deck validity indicator with tooltip listing failing rules -->
                            <TextBlock Text="{Binding DeckValidityText}"
                                       FontWeight="SemiBold"
                                       Margin="0,0,0,0">
                                <TextBlock.ToolTip>
                                    <ToolTip Placement="Mouse" Background="Transparent" BorderThickness="0" Padding="0" HasDropShadow="False">
                                        <Border Background="{DynamicResource ElevatedBrush}"
                                                Padding="6"
                                                CornerRadius="4"
                                                BorderBrush="{DynamicResource AccentBrush}"
                                                BorderThickness="1">
                                            <TextBlock Text="{Binding DeckValidationTooltip}"
                                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        </Border>
                                    </ToolTip>
                                </TextBlock.ToolTip>
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <!-- default = not valid color -->
                                        <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding DeckIsValid}" Value="True">
                                                <Setter Property="Text" Value="✓ Valid"/>
                                                <Setter Property="Foreground" Value="{DynamicResource GoldBrush}"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding DeckIsValid}" Value="False">
                                                <Setter Property="Text" Value="{Binding DeckValidityText}"/>
                                                <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Card Viewer -->
                <ContentControl Grid.Row="1" Content="{Binding CardViewer}">
                    <ContentControl.ContentTemplate>
                        <DataTemplate>
                            <controls:CardViewerControl DataContext="{Binding}" ShowWishlist="False"/>
                        </DataTemplate>
                    </ContentControl.ContentTemplate>
                </ContentControl>

                <!-- Add/Remove Buttons -->
                <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,8,0,0">
                    <Border Background="{DynamicResource ElevatedBrush}"
                            Padding="6"
                            CornerRadius="4"
                            BorderBrush="{DynamicResource AccentBrush}"
                            BorderThickness="1">
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">

                            <Button Content="−"
                                    Width="26"
                                    Height="24"
                                    Padding="0"
                                    Margin="0,0,6,0"
                                    Command="{Binding DecreaseCurrentCardQuantityCommand}"
                                    ToolTip="Decrease in-deck quantity"/>

                            <!-- Center column: label "In Deck" above the numeric quantity -->
                            <StackPanel Orientation="Vertical" VerticalAlignment="Center" HorizontalAlignment="Center" Margin="0,0">
                                <TextBlock Text="In Deck"
                                           FontSize="11"
                                           Foreground="{DynamicResource TextSecondaryBrush}"
                                           HorizontalAlignment="Center"/>
                                <TextBlock VerticalAlignment="Center"
                                           Foreground="{DynamicResource GoldBrush}"
                                           FontWeight="SemiBold"
                                           Text="{Binding CurrentInDeckQuantity}"
                                           Width="26"
                                           TextAlignment="Center"/>
                            </StackPanel>

                            <Button Content="+"
                                    Width="26"
                                    Height="24"
                                    Padding="0"
                                    Margin="6,0,0,0"
                                    Command="{Binding IncreaseCurrentCardQuantityCommand}"
                                    ToolTip="Increase in-deck quantity"/>
                        </StackPanel>
                    </Border>
                </StackPanel>
                
                <!-- Glory Card Button -->
                <Button Grid.Row="2"
                        Width="76"
                        Height="40"
                        Padding="3"
                        Margin="16,8,0,0"
                        HorizontalAlignment="Right"
                        Visibility="{Binding ShowSetGloryButton, Converter={StaticResource BoolToVisConverter}}"
                        Command="{Binding SetOrMoveGloryCommand }">
                    <TextBlock TextWrapping="Wrap" TextAlignment="Center" Text="{Binding SetGloryButtonLabel }"/>
                </Button>
            </Grid>

            <!-- GridSplitter between Center and Right -->
            <GridSplitter Grid.Column="3"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Stretch"
                          Width="6"
                          Background="{DynamicResource AccentBrush}"
                          ResizeDirection="Columns"
                          ResizeBehavior="PreviousAndNext"
                          ShowsPreview="True"
                          IsTabStop="False"/>

            <!-- Deck Lists Grid (Right side) -->
            <Grid Grid.Column="4" Margin="8">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="3*"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="3*"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="2*"/>
                </Grid.RowDefinitions>

                <!-- Leaders Section -->
                <DockPanel Grid.Row="0" Margin="0,0,0,8">
                    <TextBlock DockPanel.Dock="Top"
                               Text="Leaders" 
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource GoldBrush}"
                               Margin="0,0,0,4"/>
                    <ListBox x:Name="LeadersListBox"
                             ItemsSource="{Binding LeadersList}"
                             SelectedItem="{Binding SelectedLeader}"
                             SelectionChanged="LeadersListBox_SelectionChanged"
                             ItemContainerStyle="{StaticResource DeckBuilderListBoxItemStyle}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Name}">
                                    <TextBlock.ToolTip>
                                        <ToolTip Placement="Mouse" Background="Transparent" BorderThickness="0" Padding="0" HasDropShadow="False">
                                            <Border Background="transparent" 
                                                    Padding="0" 
                                                    CornerRadius="4" 
                                                    BorderBrush="Transparent" 
                                                    BorderThickness="0">
                                                <Image Source="{Binding ImageFile, Converter={StaticResource StringToImageConverter}}"
                                                       Width="240" Height="320" Stretch="Uniform"/>
                                            </Border>
                                        </ToolTip>
                                    </TextBlock.ToolTip>
                                </TextBlock>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </DockPanel>

                <!-- Glory Card (Gloryfinder only) -->
                <DockPanel Grid.Row="1" 
                           Visibility="{Binding ShowGloryCard, Converter={StaticResource BoolToVisConverter}}"
                           Margin="0,0,0,8">
                    <TextBlock DockPanel.Dock="Top"
                               Text="Glory Card" 
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource GoldBrush}"
                               Margin="0,0,0,4"/>
                    <ListBox x:Name="GloryCardListBox"
                             ItemsSource="{Binding GloryCardList}"
                             SelectedItem="{Binding SelectedGloryCard}"
                             SelectionChanged="GloryCardListBox_SelectionChanged"
                             ItemContainerStyle="{StaticResource DeckBuilderListBoxItemStyle}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Name}">
                                    <TextBlock.ToolTip>
                                        <ToolTip Placement="Mouse" Background="Transparent" BorderThickness="0" Padding="0" HasDropShadow="False">
                                            <Border Background="transparent" 
                                                    Padding="0" 
                                                    CornerRadius="4" 
                                                    BorderBrush="Transparent" 
                                                    BorderThickness="0">
                                                <Image Source="{Binding ImageFile, Converter={StaticResource StringToImageConverter}}"
                                                       Width="240" Height="320" Stretch="Uniform"/>
                                            </Border>
                                        </ToolTip>
                                    </TextBlock.ToolTip>
                                </TextBlock>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </DockPanel>

                <!-- Main Deck -->
                <DockPanel Grid.Row="2">
                    <controls:DeckListControl x:Name="MainDeckListControl"
                                              HeaderText="Main Deck"
                                              ItemsSource="{Binding MainDeckList}"
                                              SelectedItem="{Binding SelectedMainDeckEntry}"
                                              SelectionChanged="MainDeckListBox_SelectionChanged"
                                              IncreaseCommand="{Binding IncreaseMainDeckQuantityCommand}"
                                              DecreaseCommand="{Binding DecreaseMainDeckQuantityCommand}"
                                              ItemContainerStyle="{StaticResource DeckBuilderListBoxItemStyle}"/>
                </DockPanel>

                <GridSplitter Grid.Row="3" 
                              Height="4" 
                              HorizontalAlignment="Stretch"
                              Background="{DynamicResource AccentBrush}"
                              Margin="0,4"/>



                <!-- Evolve Deck -->
                <DockPanel Grid.Row="4">
                    <controls:DeckListControl x:Name="EvolveDeckListControl"
                                              HeaderText="Evolve Deck"
                                              ItemsSource="{Binding EvolveDeckList}"
                                              SelectedItem="{Binding SelectedEvolveDeckEntry}"
                                              SelectionChanged="EvolveDeckListBox_SelectionChanged"
                                              IncreaseCommand="{Binding IncreaseEvolveDeckQuantityCommand}"
                                              DecreaseCommand="{Binding DecreaseEvolveDeckQuantityCommand}"
                                              ItemContainerStyle="{StaticResource DeckBuilderListBoxItemStyle}"/>
                </DockPanel>

                <GridSplitter Grid.Row="5" 
                              Height="4"
                              HorizontalAlignment="Stretch"
                              Background="{DynamicResource AccentBrush}"
                              Margin="0,4"/>

                <!-- Tokens (NEW) -->
                <DockPanel Grid.Row="6" Margin="0,0,0,8">

                    <controls:DeckListControl x:Name="TokenDeckListControl"
                                              HeaderText="Tokens"
                                              ItemsSource="{Binding TokenList}"
                                              SelectedItem="{Binding SelectedTokenEntry}"
                                              SelectionChanged="TokenDeckListControl_SelectionChanged"
                                              IncreaseCommand="{Binding IncreaseTokenQuantityCommand}"
                                              DecreaseCommand="{Binding DecreaseTokenQuantityCommand}"
                                              ItemContainerStyle="{StaticResource DeckBuilderListBoxItemStyle}"/>
                </DockPanel>
            </Grid>
        </Grid>
    </Grid>
</UserControl>