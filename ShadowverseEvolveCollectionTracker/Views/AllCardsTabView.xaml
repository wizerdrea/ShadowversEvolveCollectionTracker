<UserControl x:Class="ShadowverseEvolveCardTracker.Views.AllCardsTabView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:conv="clr-namespace:ShadowverseEvolveCardTracker.Converters"
             xmlns:controls="clr-namespace:ShadowverseEvolveCardTracker.Controls"
             Background="{DynamicResource PrimaryBrush}">

    <UserControl.Resources>
        <conv:StringToImageSourceConverter x:Key="StringToImageConverter" />
        <BooleanToVisibilityConverter x:Key="BoolToVisConverter" />
        <conv:InverseBooleanToVisibilityConverter x:Key="InverseBoolToVisConverter" />

        <!-- Header context menu shared template/style (copied from DeckBuilder view) -->
        <ControlTemplate x:Key="HeaderContextMenuControlTemplate" TargetType="ContextMenu">
            <Border Background="{TemplateBinding Background}"
                    BorderBrush="{TemplateBinding BorderBrush}"
                    BorderThickness="{TemplateBinding BorderThickness}"
                    CornerRadius="6"
                    Padding="{TemplateBinding Padding}">
                <StackPanel IsItemsHost="True" />
            </Border>
        </ControlTemplate>

        <Style x:Key="HeaderContextMenuItemStyle" TargetType="MenuItem">
            <Setter Property="Background" Value="{DynamicResource SurfaceBrush}"/>
            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="MenuItem">
                        <Border Background="{TemplateBinding Background}"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter ContentSource="Header" RecognizesAccessKey="True"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Setter Property="Icon" Value="{x:Null}"/>
        </Style>

        <Style x:Key="HeaderContextMenuStyle" TargetType="ContextMenu">
            <Setter Property="Background" Value="{DynamicResource SurfaceBrush}" />
            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Padding" Value="4" />
            <Setter Property="HasDropShadow" Value="True" />
            <Setter Property="Template" Value="{StaticResource HeaderContextMenuControlTemplate}" />
            <Setter Property="ItemContainerStyle" Value="{StaticResource HeaderContextMenuItemStyle}" />
        </Style>

        <Style x:Key="AppExpanderStyle" TargetType="Expander">
            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Expander">
                        <Border Background="Transparent">
                            <StackPanel>
                                <!-- Header toggle with circular chevron -->
                                <ToggleButton x:Name="HeaderToggle"
                                      IsChecked="{Binding IsExpanded, RelativeSource={RelativeSource TemplatedParent}, Mode=TwoWay}"
                                      Cursor="Hand"
                                      Focusable="False"
                                      Background="Transparent"
                                      BorderBrush="Transparent"
                                      Padding="4"
                                      HorizontalAlignment="Left"
                                      HorizontalContentAlignment="Left">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Circular hollow chevron (outline, no base) -->
                                        <Path x:Name="ArrowPath" Data="M0,0 L8,0 L4,5 Z" Fill="{StaticResource TextPrimaryBrush}" VerticalAlignment="Center" Width="8" Height="5" RenderTransformOrigin="0.5,0.5">
                                            <Path.RenderTransform>
                                                <RotateTransform Angle="180"/>
                                            </Path.RenderTransform>
                                        </Path>

                                        <!-- Header content to the right of the arrow -->
                                        <ContentPresenter Grid.Column="1"
                                                  VerticalAlignment="Center"
                                                  HorizontalAlignment="Left"
                                                  ContentSource="Header"
                                                  RecognizesAccessKey="True"
                                                  Margin="4,0,8,0"/>
                                    </Grid>
                                </ToggleButton>

                                <!-- Collapsible content -->
                                <ContentPresenter x:Name="ExpandSite"
                                          Margin="0,6,0,0"
                                          Visibility="Collapsed"
                                          Focusable="False"
                                          ContentSource="Content"/>
                            </StackPanel>
                        </Border>

                        <ControlTemplate.Triggers>
                            <!-- When expanded: show content and tint stroke -->
                            <Trigger Property="IsExpanded" Value="True">
                                <Setter TargetName="ExpandSite" Property="Visibility" Value="Visible"/>
                            </Trigger>

                            <!-- When collapsed: show content only (do NOT set ArrowPath.Stroke here) -->
                            <Trigger Property="IsExpanded" Value="False">
                                <Setter TargetName="ExpandSite" Property="Visibility" Value="Collapsed"/>
                                <!-- removed: Setter TargetName="ArrowPath" Property="Stroke" -->
                            </Trigger>

                            <!-- Use Expander events to animate the rotate angle -->
                            <EventTrigger RoutedEvent="Expanded">
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetName="ArrowPath"
                                                 Storyboard.TargetProperty="(Path.RenderTransform).(RotateTransform.Angle)"
                                                 To="180" Duration="0:0:0.15"/>
                                    </Storyboard>
                                </BeginStoryboard>
                            </EventTrigger>
                            <EventTrigger RoutedEvent="Collapsed">
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetName="ArrowPath"
                                                 Storyboard.TargetProperty="(Path.RenderTransform).(RotateTransform.Angle)"
                                                 To="0" Duration="0:0:0.15"/>
                                    </Storyboard>
                                </BeginStoryboard>
                            </EventTrigger>

                            <!-- Mouse-over stroke change (placed AFTER IsExpanded triggers so it can take precedence) -->
                            <Trigger SourceName="HeaderToggle" Property="IsMouseOver" Value="True">
                                <Setter TargetName="ArrowPath" Property="Stroke" Value="{StaticResource GoldBrush}"/>
                            </Trigger>

                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.6"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="FilterDropdownToggleButtonStyle" TargetType="ToggleButton">
            <Setter Property="Background" Value="{DynamicResource SurfaceBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="6,4"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="Bd"
                        Background="{TemplateBinding Background}"
                        BorderBrush="{TemplateBinding BorderBrush}"
                        BorderThickness="{TemplateBinding BorderThickness}"
                        CornerRadius="6"
                        Padding="{TemplateBinding Padding}">
                            <Grid>
                                <ContentPresenter VerticalAlignment="Center" HorizontalAlignment="Center"/>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{StaticResource ElevatedBrush}"/>
                                <Setter TargetName="Bd" Property="BorderBrush" Value="{DynamicResource AccentBrush}"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{StaticResource SelectedBrush}"/>
                                <Setter TargetName="Bd" Property="BorderBrush" Value="{DynamicResource AccentBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Bd" Property="Opacity" Value="0.6"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- CollectionViewSources for header context menus -->
        <CollectionViewSource x:Key="RarityFilters" Source="{Binding RarityFilters}"/>
        <CollectionViewSource x:Key="TypeFilters" Source="{Binding TypeFilters}"/>
        <CollectionViewSource x:Key="ClassFilters" Source="{Binding ClassFilters}"/>
        <CollectionViewSource x:Key="SetFilters" Source="{Binding SetFilters}"/>
        <CollectionViewSource x:Key="CostFilters" Source="{Binding CostFilters}"/>
        <CollectionViewSource x:Key="OwnedFilters" Source="{Binding OwnedFilters}"/>
        <CollectionViewSource x:Key="TraitsFilters" Source="{Binding TraitsFilters}"/>
        <!-- ToggleButton style removed from here; now provided globally in App.xaml -->
    </UserControl.Resources>

    <Grid Margin="8">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
            <!-- Increased default width so card viewer shows both action buttons side-by-side -->
            <ColumnDefinition Width="330" MinWidth="150"/>
        </Grid.ColumnDefinitions>

        <!-- DataGrid with "no data" message -->
        <Grid Grid.Column="0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <Expander Grid.Row="0" Margin="8,0,8,4" Header="Filters" IsExpanded="True" Style="{StaticResource AppExpanderStyle}">
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="Name" VerticalAlignment="Center" Margin="0,0,6,0"/>
                        <TextBox Width="220"
                                 Text="{Binding NameFilter, UpdateSourceTrigger=PropertyChanged}">
                            <TextBox.ToolTip>
                                <ToolTip Placement="Mouse" Background="Transparent" BorderThickness="0" Padding="0" HasDropShadow="False">
                                    <Border Background="{DynamicResource ElevatedBrush}"
                                            Padding="6"
                                            CornerRadius="4"
                                            BorderBrush="{DynamicResource AccentBrush}"
                                            BorderThickness="1">
                                        <TextBlock Text="Filter cards by name using a regex (or plain text if regex invalid)"
                                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    </Border>
                                </ToolTip>
                            </TextBox.ToolTip>
                        </TextBox>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="Card #" VerticalAlignment="Center" Margin="12,0,6,0"/>
                        <TextBox Width="80"
                                 Text="{Binding CardNumberFilter, UpdateSourceTrigger=PropertyChanged}">
                            <TextBox.ToolTip>
                                <ToolTip Placement="Mouse" Background="Transparent" BorderThickness="0" Padding="0" HasDropShadow="False">
                                    <Border Background="{DynamicResource ElevatedBrush}"
                                            Padding="6"
                                            CornerRadius="4"
                                            BorderBrush="{DynamicResource AccentBrush}"
                                            BorderThickness="1">
                                        <TextBlock Text="Filter cards by text by using a regex (or plain text if regex invalid)"
                                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    </Border>
                                </ToolTip>
                            </TextBox.ToolTip>
                        </TextBox>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="Text" VerticalAlignment="Center" Margin="12,0,6,0"/>
                        <TextBox Width="220" 
                     Text="{Binding TextFilter, UpdateSourceTrigger=PropertyChanged}">
                            <TextBox.ToolTip>
                                <ToolTip Placement="Mouse" Background="Transparent" BorderThickness="0" Padding="0" HasDropShadow="False">
                                    <Border Background="{DynamicResource ElevatedBrush}"
                                            Padding="6"
                                            CornerRadius="4"
                                            BorderBrush="{DynamicResource AccentBrush}"
                                            BorderThickness="1">
                                        <TextBlock Text="Filter cards by number by using a regex (or plain text if regex invalid)"
                                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    </Border>
                                </ToolTip>
                            </TextBox.ToolTip>
                        </TextBox>
                    </StackPanel>

                    <!-- Traits dropdown (toggle + popup) -->
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="12,0,0,0">
                        <ToggleButton x:Name="TraitsToggle"
                          Style="{StaticResource FilterDropdownToggleButtonStyle}"
                          Width="120"
                          HorizontalAlignment="Left"
                          Checked="TraitsToggle_Checked"
                          Unchecked="TraitsToggle_Unchecked">
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                <TextBlock Text="Traits" Margin="0,0,6,0" VerticalAlignment="Center" Foreground="{StaticResource TextPrimaryBrush}" />
                                <!-- arrow path; we'll rotate it in code-behind when popup opens/closes -->
                                <Path x:Name="TraitsArrowPath" Data="M0,0 L8,0 L4,5 Z" Fill="{StaticResource TextPrimaryBrush}" VerticalAlignment="Center" Width="8" Height="5" RenderTransformOrigin="0.5,0.5">
                                    <Path.RenderTransform>
                                        <RotateTransform Angle="0"/>
                                    </Path.RenderTransform>
                                </Path>
                            </StackPanel>
                        </ToggleButton>

                        <Popup x:Name="TraitsPopup"
                   Placement="Bottom"
                   PlacementTarget="{Binding ElementName=TraitsToggle}"
                   StaysOpen="False"
                   AllowsTransparency="True"
                   PopupAnimation="Fade"
                   Closed="TraitsPopup_Closed">
                            <Border Background="{DynamicResource SurfaceBrush}" Padding="6" CornerRadius="6" BorderBrush="{StaticResource BorderBrush}" BorderThickness="1" Width="280">
                                <StackPanel>
                                    <TextBlock Text="Select Traits (multi-select)" FontWeight="SemiBold" Margin="0,0,0,6"/>
                                    <ScrollViewer Height="180" VerticalScrollBarVisibility="Auto">
                                        <ItemsControl ItemsSource="{Binding TraitsFilters}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <CheckBox Content="{Binding Name}" IsChecked="{Binding IsChecked, Mode=TwoWay}" Padding="4,2"/>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>

                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,8,0,0">
                                        <!-- Buttons keep their names; code-behind wires click handlers -->
                                        <Button x:Name="SelectAllTraitsButton" Content="Select All" Margin="0,0,6,0"/>
                                        <Button x:Name="ClearAllTraitsButton" Content="Clear All"/>
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                        </Popup>
                    </StackPanel>
                </StackPanel>
            </Expander>

            <Grid Grid.Row="1">
                <DataGrid x:Name="AllCardsDataGrid"
                          ItemsSource="{Binding FilteredCards}"
                          AutoGenerateColumns="False"
                          IsReadOnly="False"
                          CanUserAddRows="False"
                          SelectedItem="{Binding SelectedCard, Mode=TwoWay}"
                          Background="{DynamicResource PrimaryBrush}">
                    <DataGrid.RowStyle>
                        <Style TargetType="DataGridRow" BasedOn="{StaticResource {x:Type DataGridRow}}">
                            <Setter Property="ToolTip">
                                <Setter.Value>
                                    <ToolTip Placement="Mouse" Background="Transparent" BorderThickness="0" Padding="0" HasDropShadow="False">
                                        <Border Background="transparent" 
                                                Padding="0" 
                                                CornerRadius="4" 
                                                BorderBrush="Transparent" 
                                                BorderThickness="0">
                                            <Image Source="{Binding ImageFile, Converter={StaticResource StringToImageConverter}}"
                                                   Width="240" Height="320" Stretch="Uniform"/>
                                        </Border>
                                    </ToolTip>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </DataGrid.RowStyle>

                    <DataGrid.Columns>
                        <!-- Favorite star column (far left) with header toggle -->
                        <DataGridTemplateColumn Width="40" IsReadOnly="False">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <ToggleButton IsChecked="{Binding IsFavorite, Mode=TwoWay}"
                                                  Click="CardFavoriteToggle_Click"
                                                  Cursor="Hand"
                                                  Focusable="False"
                                                  HorizontalAlignment="Center"
                                                  VerticalAlignment="Center">
                                        <ToggleButton.Template>
                                            <ControlTemplate TargetType="ToggleButton">
                                                <Border Background="{TemplateBinding Background}"
                                                        BorderBrush="{TemplateBinding BorderBrush}"
                                                        BorderThickness="{TemplateBinding BorderThickness}">
                                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                </Border>
                                            </ControlTemplate>
                                        </ToggleButton.Template>
                                        <ToggleButton.ToolTip>
                                            <ToolTip Placement="Mouse" Background="Transparent" BorderThickness="0" Padding="0" HasDropShadow="False">
                                                <Border Background="{DynamicResource ElevatedBrush}"
                                                        Padding="6"
                                                        CornerRadius="4"
                                                        BorderBrush="{DynamicResource AccentBrush}"
                                                        BorderThickness="1">
                                                    <TextBlock Text="Toggle favorite"
                                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                </Border>
                                            </ToolTip>
                                        </ToggleButton.ToolTip>

                                        <Viewbox Width="18" Height="18">
                                            <Canvas Width="24" Height="24">
                                                <!-- Filled star when checked -->
                                                <Path Fill="{DynamicResource GoldBrush}"
                                                      Data="M12,17.27 L18.18,21 L16.54,13.97 L22,9.24 L14.81,8.63 L12,2 L9.19,8.63 L2,9.24 L7.46,13.97 L5.82,21 z"
                                                      Visibility="{Binding IsChecked, RelativeSource={RelativeSource AncestorType=ToggleButton}, Converter={StaticResource BoolToVisConverter}}"/>
                                                <!-- Outline star when unchecked -->
                                                <Path Stroke="{DynamicResource GoldBrush}"
                                                      Fill="Transparent"
                                                      StrokeThickness="1.6"
                                                      Data="M12,17.27 L18.18,21 L16.54,13.97 L22,9.24 L14.81,8.63 L12,2 L9.19,8.63 L2,9.24 L7.46,13.97 L5.82,21 z"
                                                      Visibility="Visible"/>
                                            </Canvas>
                                        </Viewbox>
                                    </ToggleButton>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>

                            <DataGridTemplateColumn.HeaderTemplate>
                                <DataTemplate>
                                    <!-- Header toggle: binds to outer DataContext.FavoritesOnly -->
                                    <ToggleButton Cursor="Hand"
                                                  Focusable="False"
                                                  HorizontalAlignment="Center"
                                                  VerticalAlignment="Center"
                                                  IsChecked="{Binding DataContext.FavoritesOnly, RelativeSource={RelativeSource AncestorType=UserControl}, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                        <ToggleButton.Template>
                                            <ControlTemplate TargetType="ToggleButton">
                                                <Border Background="{TemplateBinding Background}"
                                                        BorderBrush="{TemplateBinding BorderBrush}"
                                                        BorderThickness="{TemplateBinding BorderThickness}">
                                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                </Border>
                                            </ControlTemplate>
                                        </ToggleButton.Template>

                                        <ToggleButton.ToolTip>
                                            <ToolTip Placement="Mouse" Background="Transparent" BorderThickness="0" Padding="0" HasDropShadow="False">
                                                <Border Background="{DynamicResource ElevatedBrush}"
                                                        Padding="6"
                                                        CornerRadius="4"
                                                        BorderBrush="{DynamicResource AccentBrush}"
                                                        BorderThickness="1">
                                                    <TextBlock Text="Show favorites only"
                                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                </Border>
                                            </ToolTip>
                                        </ToggleButton.ToolTip>

                                        <Viewbox Width="18" Height="18">
                                            <Canvas Width="24" Height="24">
                                                <!-- Filled star when header is checked -->
                                                <Path Fill="{DynamicResource GoldBrush}"
                                                      Data="M12,17.27 L18.18,21 L16.54,13.97 L22,9.24 L14.81,8.63 L12,2 L9.19,8.63 L2,9.24 L7.46,13.97 L5.82,21 z"
                                                      Visibility="{Binding IsChecked, RelativeSource={RelativeSource AncestorType=ToggleButton}, Converter={StaticResource BoolToVisConverter}}"/>
                                                <!-- Outline star when header isunchecked -->
                                                <Path Stroke="{DynamicResource GoldBrush}"
                                                      Fill="Transparent"
                                                      StrokeThickness="1.6"
                                                      Data="M12,17.27 L18.18,21 L16.54,13.97 L22,9.24 L14.81,8.63 L12,2 L9.19,8.63 L2,9.24 L7.46,13.97 L5.82,21 z"
                                                      Visibility="Visible"/>
                                            </Canvas>
                                        </Viewbox>
                                    </ToggleButton>
                                </DataTemplate>
                            </DataGridTemplateColumn.HeaderTemplate>
                        </DataGridTemplateColumn>

                        <DataGridTextColumn Binding="{Binding Name}" IsReadOnly="True" Width="2*">
                            <DataGridTextColumn.HeaderTemplate>
                                <DataTemplate>
                                    <StackPanel>
                                        <TextBlock Text="Name"/>
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTextColumn.HeaderTemplate>
                        </DataGridTextColumn>

                        <DataGridTextColumn Binding="{Binding CardNumber}" IsReadOnly="True" Width="*">
                            <DataGridTextColumn.HeaderTemplate>
                                <DataTemplate>
                                    <StackPanel>
                                        <TextBlock Text="Card #"/>
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTextColumn.HeaderTemplate>
                        </DataGridTextColumn>

                        

                        <!-- Rarity header context menu -->
                        <DataGridTextColumn Binding="{Binding Rarity}" IsReadOnly="True" Width="*">
                            <DataGridTextColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="Background" Value="{DynamicResource HeaderGradientBrush}" />
                                    <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                                    <Setter Property="Foreground" Value="{StaticResource GoldBrush}"/>
                                    <Setter Property="Padding" Value="8,8"/>
                                    <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
                                    <Setter Property="BorderThickness" Value="0,0,1,1"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                    <Setter Property="HorizontalContentAlignment" Value="Left"/>

                                    <Setter Property="ContextMenu">
                                        <Setter.Value>
                                            <ContextMenu Style="{StaticResource HeaderContextMenuStyle}">
                                                <ContextMenu.ItemsSource>
                                                    <CompositeCollection>
                                                        <CollectionContainer Collection="{Binding Source={StaticResource RarityFilters}}"/>
                                                        <MenuItem Header="Select All"
                                                                  Command="{Binding SelectAllRarityFiltersCommand}"/>
                                                        <MenuItem Header="Clear All"
                                                                  Command="{Binding ClearAllRarityFiltersCommand}"/>
                                                    </CompositeCollection>
                                                </ContextMenu.ItemsSource>

                                                <ContextMenu.ItemTemplate>
                                                    <DataTemplate>
                                                        <CheckBox VerticalAlignment="Center" HorizontalAlignment="Left" OverridesDefaultStyle="False"
                                                                  BorderThickness="0"
                                                                  Content="{Binding Name}"
                                                                  IsChecked="{Binding IsChecked, Mode=TwoWay}"
                                                                  Padding="6,4"/>
                                                    </DataTemplate>
                                                </ContextMenu.ItemTemplate>
                                            </ContextMenu>
                                        </Setter.Value>
                                    </Setter>

                                    <Setter Property="ContentTemplate">
                                        <Setter.Value>
                                            <DataTemplate>
                                                <TextBlock Text="Rarity" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </DataTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </DataGridTextColumn.HeaderStyle>
                        </DataGridTextColumn>

                        <!-- Type header context menu -->
                        <DataGridTextColumn Binding="{Binding Type}" IsReadOnly="True" Width="*">
                            <DataGridTextColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="Background" Value="{DynamicResource HeaderGradientBrush}" />
                                    <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                                    <Setter Property="Foreground" Value="{StaticResource GoldBrush}"/>
                                    <Setter Property="Padding" Value="8,8"/>
                                    <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
                                    <Setter Property="BorderThickness" Value="0,0,1,1"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                    <Setter Property="HorizontalContentAlignment" Value="Left"/>

                                    <Setter Property="ContextMenu">
                                        <Setter.Value>
                                            <ContextMenu Style="{StaticResource HeaderContextMenuStyle}">
                                                <ContextMenu.ItemsSource>
                                                    <CompositeCollection>
                                                        <CollectionContainer Collection="{Binding Source={StaticResource TypeFilters}}"/>
                                                        <MenuItem Header="Select All"
                                                                  Command="{Binding SelectAllTypeFiltersCommand}"/>
                                                        <MenuItem Header="Clear All"
                                                                  Command="{Binding ClearAllTypeFiltersCommand}"/>
                                                    </CompositeCollection>
                                                </ContextMenu.ItemsSource>

                                                <ContextMenu.ItemTemplate>
                                                    <DataTemplate>
                                                        <CheckBox VerticalAlignment="Center" HorizontalAlignment="Left" OverridesDefaultStyle="False"
                                                                  BorderThickness="0"
                                                                  Content="{Binding Name}"
                                                                  IsChecked="{Binding IsChecked, Mode=TwoWay}"
                                                                  Padding="6,4"/>
                                                    </DataTemplate>
                                                </ContextMenu.ItemTemplate>
                                            </ContextMenu>
                                        </Setter.Value>
                                    </Setter>

                                    <Setter Property="ContentTemplate">
                                        <Setter.Value>
                                            <DataTemplate>
                                                <TextBlock Text="Type" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </DataTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </DataGridTextColumn.HeaderStyle>
                        </DataGridTextColumn>

                        <!-- Class column with context menu -->
                        <DataGridTemplateColumn Header="Class" Width="*">
                            <DataGridTemplateColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="Background" Value="{DynamicResource HeaderGradientBrush}" />
                                    <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                                    <Setter Property="Foreground" Value="{StaticResource GoldBrush}"/>
                                    <Setter Property="Padding" Value="8,8"/>
                                    <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
                                    <Setter Property="BorderThickness" Value="0,0,1,1"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                    <Setter Property="HorizontalContentAlignment" Value="Left"/>

                                    <Setter Property="ContextMenu">
                                        <Setter.Value>
                                            <ContextMenu Style="{StaticResource HeaderContextMenuStyle}">
                                                <ContextMenu.ItemsSource>
                                                    <CompositeCollection>
                                                        <CollectionContainer Collection="{Binding Source={StaticResource ClassFilters}}"/>
                                                        <MenuItem Header="Select All"
                                                                  Command="{Binding SelectAllClassFiltersCommand}"/>
                                                        <MenuItem Header="Clear All"
                                                                  Command="{Binding ClearAllClassFiltersCommand}"/>
                                                    </CompositeCollection>
                                                </ContextMenu.ItemsSource>

                                                <ContextMenu.ItemTemplate>
                                                    <DataTemplate>
                                                        <CheckBox VerticalAlignment="Center" HorizontalAlignment="Left" OverridesDefaultStyle="False"
                                                                  BorderThickness="0"
                                                                  Content="{Binding Name}"
                                                                  IsChecked="{Binding IsChecked, Mode=TwoWay}"
                                                                  Padding="6,4"/>
                                                    </DataTemplate>
                                                </ContextMenu.ItemTemplate>
                                            </ContextMenu>
                                        </Setter.Value>
                                    </Setter>

                                    <Setter Property="ContentTemplate">
                                        <Setter.Value>
                                            <DataTemplate>
                                                <TextBlock Text="Class" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </DataTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </DataGridTemplateColumn.HeaderStyle>

                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Class}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <!-- Set column header context menu -->
                        <DataGridTextColumn Binding="{Binding Set}" IsReadOnly="True" Width="2*">
                            <DataGridTextColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="Background" Value="{DynamicResource HeaderGradientBrush}" />
                                    <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                                    <Setter Property="Foreground" Value="{StaticResource GoldBrush}"/>
                                    <Setter Property="Padding" Value="8,8"/>
                                    <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
                                    <Setter Property="BorderThickness" Value="0,0,1,1"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                    <Setter Property="HorizontalContentAlignment" Value="Left"/>

                                    <Setter Property="ContextMenu">
                                        <Setter.Value>
                                            <ContextMenu Style="{StaticResource HeaderContextMenuStyle}">
                                                <ContextMenu.ItemsSource>
                                                    <CompositeCollection>
                                                        <CollectionContainer Collection="{Binding Source={StaticResource SetFilters}}"/>
                                                        <MenuItem Header="Select All"
                                                                  Command="{Binding SelectAllSetFiltersCommand}"/>
                                                        <MenuItem Header="Clear All"
                                                                  Command="{Binding ClearAllSetFiltersCommand}"/>
                                                    </CompositeCollection>
                                                </ContextMenu.ItemsSource>

                                                <ContextMenu.ItemTemplate>
                                                    <DataTemplate>
                                                        <CheckBox VerticalAlignment="Center" HorizontalAlignment="Left" OverridesDefaultStyle="False"
                                                                  BorderThickness="0"
                                                                  Content="{Binding Name}"
                                                                  IsChecked="{Binding IsChecked, Mode=TwoWay}"
                                                                  Padding="6,4"/>
                                                    </DataTemplate>
                                                </ContextMenu.ItemTemplate>
                                            </ContextMenu>
                                        </Setter.Value>
                                    </Setter>

                                    <Setter Property="ContentTemplate">
                                        <Setter.Value>
                                            <DataTemplate>
                                                <TextBlock Text="Set" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </DataTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </DataGridTextColumn.HeaderStyle>
                        </DataGridTextColumn>

                        <DataGridTextColumn Binding="{Binding Traits}" IsReadOnly="True" Width="2*">
                            <DataGridTextColumn.HeaderTemplate>
                                <DataTemplate>
                                    <StackPanel>
                                        <TextBlock Text="Traits"/>
                                     </StackPanel>
                                </DataTemplate>
                            </DataGridTextColumn.HeaderTemplate>
                        </DataGridTextColumn>

                        <DataGridTextColumn Binding="{Binding Text}" IsReadOnly="True" Width="2*">
                            <DataGridTextColumn.HeaderTemplate>
                                <DataTemplate>
                                    <StackPanel>
                                        <TextBlock Text="Text"/>
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTextColumn.HeaderTemplate>
                        </DataGridTextColumn>

                        <!-- Qty Owned column converted to header context menu like DeckBuilder -->
                        <DataGridTextColumn Header="Qty Owned" Binding="{Binding QuantityOwned}" IsReadOnly="True" Width="80">
                            <DataGridTextColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="Background" Value="{DynamicResource HeaderGradientBrush}" />
                                    <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                                    <Setter Property="Foreground" Value="{StaticResource GoldBrush}"/>
                                    <Setter Property="Padding" Value="8,8"/>
                                    <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
                                    <Setter Property="BorderThickness" Value="0,0,1,1"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                    <Setter Property="HorizontalContentAlignment" Value="Left"/>

                                    <Setter Property="ContextMenu">
                                        <Setter.Value>
                                            <ContextMenu Style="{StaticResource HeaderContextMenuStyle}">
                                                <ContextMenu.ItemsSource>
                                                    <CompositeCollection>
                                                        <CollectionContainer Collection="{Binding Source={StaticResource OwnedFilters}}"/>
                                                        <MenuItem Header="Select All"
                                          Command="{Binding SelectAllOwnedFiltersCommand}"/>
                                                        <MenuItem Header="Clear All"
                                          Command="{Binding ClearAllOwnedFiltersCommand}"/>
                                                    </CompositeCollection>
                                                </ContextMenu.ItemsSource>

                                                <ContextMenu.ItemTemplate>
                                                    <DataTemplate>
                                                        <CheckBox VerticalAlignment="Center" HorizontalAlignment="Left" OverridesDefaultStyle="False"
                                          BorderThickness="0"
                                          Content="{Binding Name}"
                                          IsChecked="{Binding IsChecked, Mode=TwoWay}"
                                          Padding="6,4"/>
                                                    </DataTemplate>
                                                </ContextMenu.ItemTemplate>
                                            </ContextMenu>
                                        </Setter.Value>
                                    </Setter>

                                    <Setter Property="ContentTemplate">
                                        <Setter.Value>
                                            <DataTemplate>
                                                <TextBlock Text="# Owned" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </DataTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </DataGridTextColumn.HeaderStyle>
                        </DataGridTextColumn>

                        <DataGridTemplateColumn Width="SizeToHeader" IsReadOnly="False">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <!-- Use the same themed ToggleButton as favorites so wishlist matches app UI -->
                                    <ToggleButton IsChecked="{Binding IsWishlisted, Mode=TwoWay}"
                                                  Click="CardWishlistToggle_Click"
                                                  Cursor="Hand"
                                                  Focusable="False"
                                                  HorizontalAlignment="Center"
                                                  VerticalAlignment="Center">
                                        <ToggleButton.Template>
                                            <ControlTemplate TargetType="ToggleButton">
                                                <Border Background="{TemplateBinding Background}"
                                                        BorderBrush="{TemplateBinding BorderBrush}"
                                                        BorderThickness="{TemplateBinding BorderThickness}">
                                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                </Border>
                                            </ControlTemplate>
                                        </ToggleButton.Template>

                                        <ToggleButton.ToolTip>
                                            <ToolTip Placement="Mouse" Background="Transparent" BorderThickness="0" Padding="0" HasDropShadow="False">
                                                <Border Background="{DynamicResource ElevatedBrush}"
                                                        Padding="6"
                                                        CornerRadius="4"
                                                        BorderBrush="{DynamicResource AccentBrush}"
                                                        BorderThickness="1">
                                                    <TextBlock Text="Toggle wishlist"
                                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                </Border>
                                            </ToolTip>
                                        </ToggleButton.ToolTip>

                                        <Viewbox Width="18" Height="18">
                                            <Canvas Width="24" Height="24">
                                                <!-- Filled heart when checked -->
                                                <Path Fill="{DynamicResource GoldBrush}"
                                                      Data="M12,21 C12,21 4,14 4,9 C4,6.2386 6.2386,4 9,4 C10.6569,4 12,5.3431 12,5.3431 C12,5.3431 13.3431,4 15,4 C17.7614,4 20,6.2386 20,9 C20,14 12,21 12,21 z"
                                                      Visibility="{Binding IsChecked, RelativeSource={RelativeSource AncestorType=ToggleButton}, Converter={StaticResource BoolToVisConverter}}"/>
                                                <!-- Outline heart when unchecked -->
                                                <Path Stroke="{DynamicResource GoldBrush}"
                                                      Fill="Transparent"
                                                      StrokeThickness="1.6"
                                                      Data="M12,21 C12,21 4,14 4,9 C4,6.2386 6.2386,4 9,4 C10.6569,4 12,5.3431 12,5.3431 C12,5.3431 13.3431,4 15,4 C17.7614,4 20,6.2386 20,9 C20,14 12,21 12,21 z"
                                                      Visibility="Visible"/>
                                            </Canvas>
                                        </Viewbox>
                                    </ToggleButton>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>

                            <DataGridTemplateColumn.HeaderTemplate>
                                <DataTemplate>
                                    <StackPanel>
                                        <TextBlock Text="Wishlisted" HorizontalAlignment="Center"/>
                                        <ToggleButton Cursor="Hand"
                                                      Focusable="False"
                                                      HorizontalAlignment="Center"
                                                      VerticalAlignment="Center"
                                                      IsChecked="{Binding DataContext.WishlistedOnly, RelativeSource={RelativeSource AncestorType=UserControl}, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                            <ToggleButton.Template>
                                                <ControlTemplate TargetType="ToggleButton">
                                                    <Border Background="{TemplateBinding Background}"
                                                            BorderBrush="{TemplateBinding BorderBrush}"
                                                            BorderThickness="{TemplateBinding BorderThickness}">
                                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>
                                                </ControlTemplate>
                                            </ToggleButton.Template>

                                            <ToggleButton.ToolTip>
                                                <ToolTip Placement="Mouse" Background="Transparent" BorderThickness="0" Padding="0" HasDropShadow="False">
                                                    <Border Background="{DynamicResource ElevatedBrush}"
                                                            Padding="6"
                                                            CornerRadius="4"
                                                            BorderBrush="{DynamicResource AccentBrush}"
                                                            BorderThickness="1">
                                                        <TextBlock Text="Show wishlisted only"
                                                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                    </Border>
                                                </ToolTip>
                                            </ToggleButton.ToolTip>

                                            <Viewbox Width="18" Height="18">
                                                <Canvas Width="24" Height="24">
                                                    <Path Fill="{DynamicResource GoldBrush}"
                                                          Data="M12,21 C12,21 4,14 4,9 C4,6.2386 6.2386,4 9,4 C10.6569,4 12,5.3431 12,5.3431 C12,5.3431 13.3431,4 15,4 C17.7614,4 20,6.2386 20,9 C20,14 12,21 12,21 z"
                                                          Visibility="{Binding IsChecked, RelativeSource={RelativeSource AncestorType=ToggleButton}, Converter={StaticResource BoolToVisConverter}}"/>
                                                    <Path Stroke="{DynamicResource GoldBrush}"
                                                          Fill="Transparent"
                                                          StrokeThickness="1.6"
                                                          Data="M12,21 C12,21 4,14 4,9 C4,6.2386 6.2386,4 9,4 C10.6569,4 12,5.3431 12,5.3431 C12,5.3431 13.3431,4 15,4 C17.7614,4 20,6.2386 20,9 C20,14 12,21 12,21 z"
                                                          Visibility="Visible"/>
                                                </Canvas>
                                            </Viewbox>
                                        </ToggleButton>
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTemplateColumn.HeaderTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>

                <TextBlock Text="No card data loaded. Use File → Select Folder and Load to load CSV files."
                           Foreground="{DynamicResource TextSecondaryBrush}"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           TextWrapping="Wrap"
                           TextAlignment="Center"
                           Width="380">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding HasItems, ElementName=AllCardsDataGrid}" Value="False">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
            </Grid>
        </Grid>

        <GridSplitter Grid.Column="1"
                      Width="6"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Stretch"
                      ShowsPreview="True"
                      ResizeDirection="Columns"
                      Cursor="SizeWE"/>

        <controls:CardViewerControl Grid.Column="2"
                                    Margin="8,0,0,0"
                                    DataContext="{Binding CardViewer}"/>
    </Grid>
</UserControl>