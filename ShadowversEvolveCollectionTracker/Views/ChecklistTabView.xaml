<UserControl x:Class="ShadowversEvolveCardTracker.Views.ChecklistTabView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:conv="clr-namespace:ShadowversEvolveCardTracker.Converters"
             xmlns:controls="clr-namespace:ShadowversEvolveCardTracker.Controls"
             Background="{DynamicResource PrimaryBrush}">

    <UserControl.Resources>
        <conv:StringToImageSourceConverter x:Key="StringToImageConverter" />
        <conv:TotalQuantityToCategoryConverter x:Key="TotalQuantityToCategoryConverter" />
        <conv:CombinedCountToCategoryConverter x:Key="CombinedCountToCategoryConverter" />
        <BooleanToVisibilityConverter x:Key="BoolToVisConverter" />
        <conv:InverseBooleanToVisibilityConverter x:Key="InverseBoolToVisConverter" />
    </UserControl.Resources>

    <Grid Margin="8">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="6" />
            <ColumnDefinition Width="320" MinWidth="200" />
        </Grid.ColumnDefinitions>

        <!-- Wrap the DataGrid in a Grid so we can overlay a "calculating" message -->
        <Grid Grid.Column="0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- removed top checkbox (Favorites filter moved to star column header) -->

            <Grid Grid.Row="1">
                <DataGrid ItemsSource="{Binding ChecklistView}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          CanUserAddRows="False"
                          SelectedItem="{Binding SelectedCombinedCard, Mode=TwoWay}"
                          Background="{DynamicResource PrimaryBrush}">
                    <!-- Image tooltip for combined-group rows (shows first card image) -->
                    <DataGrid.RowStyle>
                        <Style TargetType="DataGridRow" BasedOn="{StaticResource {x:Type DataGridRow}}">
                            <Setter Property="ToolTip">
                                <Setter.Value>
                                    <ToolTip Placement="Mouse" Background="Transparent" BorderThickness="0" Padding="0" HasDropShadow="False">
                                        <Border Background="Transparent"
                                                Padding="0"
                                                CornerRadius="4"
                                                BorderBrush="Transparent"
                                                BorderThickness="0">
                                            <Image Source="{Binding Cards[0].ImageFile, Converter={StaticResource StringToImageConverter}}"
                                                   Width="240" Height="320" Stretch="Uniform"/>
                                        </Border>
                                    </ToolTip>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </DataGrid.RowStyle>

                    <DataGrid.Columns>
                        <!-- Favorite star column for combined groups with header toggle -->
                        <DataGridTemplateColumn Width="40" IsReadOnly="False">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <ToggleButton ToolTip="Toggle favorites for this group"
                                                  Cursor="Hand"
                                                  Background="Transparent"
                                                  BorderThickness="0"
                                                  Focusable="False"
                                                  OverridesDefaultStyle="True"
                                                  HorizontalAlignment="Center"
                                                  VerticalAlignment="Center"
                                                  Click="GroupFavoriteToggle_Click"
                                                  IsChecked="{Binding HasFavorite, Mode=OneWay}">
                                        <ToggleButton.Template>
                                            <ControlTemplate TargetType="ToggleButton">
                                                <Border Background="{TemplateBinding Background}"
                                                        BorderBrush="{TemplateBinding BorderBrush}"
                                                        BorderThickness="{TemplateBinding BorderThickness}">
                                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                </Border>
                                            </ControlTemplate>
                                        </ToggleButton.Template>

                                        <Viewbox Width="18" Height="18">
                                            <Canvas Width="24" Height="24">
                                                <!-- Filled star when the group has any favorite -->
                                                <Path Fill="{DynamicResource GoldBrush}"
                                                      Data="M12,17.27 L18.18,21 L16.54,13.97 L22,9.24 L14.81,8.63 L12,2 L9.19,8.63 L2,9.24 L7.46,13.97 L5.82,21 z"
                                                      Visibility="{Binding IsChecked, RelativeSource={RelativeSource AncestorType=ToggleButton}, Converter={StaticResource BoolToVisConverter}}"/>
                                                <!-- Outline star Always Visible -->
                                                <Path Stroke="{DynamicResource GoldBrush}"
                                                      Fill="Transparent"
                                                      StrokeThickness="1.6"
                                                      Data="M12,17.27 L18.18,21 L16.54,13.97 L22,9.24 L14.81,8.63 L12,2 L9.19,8.63 L2,9.24 L7.46,13.97 L5.82,21 z"
                                                      Visibility="Visible"/>
                                            </Canvas>
                                        </Viewbox>
                                    </ToggleButton>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>

                            <DataGridTemplateColumn.HeaderTemplate>
                                <DataTemplate>
                                    <!-- Header toggle: binds to outer DataContext.FavoritesOnly -->
                                    <ToggleButton ToolTip="Show favorites only"
                                                  Cursor="Hand"
                                                  Background="Transparent"
                                                  BorderThickness="0"
                                                  Focusable="False"
                                                  OverridesDefaultStyle="True"
                                                  HorizontalAlignment="Center"
                                                  VerticalAlignment="Center"
                                                  IsChecked="{Binding DataContext.FavoritesOnly, RelativeSource={RelativeSource AncestorType=UserControl}, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                        <ToggleButton.Template>
                                            <ControlTemplate TargetType="ToggleButton">
                                                <Border Background="{TemplateBinding Background}"
                                                        BorderBrush="{TemplateBinding BorderBrush}"
                                                        BorderThickness="{TemplateBinding BorderThickness}">
                                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                </Border>
                                            </ControlTemplate>
                                        </ToggleButton.Template>

                                        <Viewbox Width="18" Height="18">
                                            <Canvas Width="24" Height="24">
                                                <!-- Filled star when header is checked -->
                                                <Path Fill="{DynamicResource GoldBrush}"
                                                      Data="M12,17.27 L18.18,21 L16.54,13.97 L22,9.24 L14.81,8.63 L12,2 L9.19,8.63 L2,9.24 L7.46,13.97 L5.82,21 z"
                                                      Visibility="{Binding IsChecked, RelativeSource={RelativeSource AncestorType=ToggleButton}, Converter={StaticResource BoolToVisConverter}}"/>
                                                <!-- Outline star when header is unchecked -->
                                                <Path Stroke="{DynamicResource GoldBrush}"
                                                      Fill="Transparent"
                                                      StrokeThickness="1.6"
                                                      Data="M12,17.27 L18.18,21 L16.54,13.97 L22,9.24 L14.81,8.63 L12,2 L9.19,8.63 L2,9.24 L7.46,13.97 L5.82,21 z"
                                                      Visibility="Visible"/>
                                            </Canvas>
                                        </Viewbox>
                                    </ToggleButton>
                                </DataTemplate>
                            </DataGridTemplateColumn.HeaderTemplate>
                        </DataGridTemplateColumn>

                        <DataGridTextColumn Binding="{Binding Name}" Width="3*">
                            <DataGridTextColumn.HeaderTemplate>
                                <DataTemplate>
                                    <StackPanel>
                                        <TextBlock Text="Card Name"/>
                                        <TextBox Text="{Binding DataContext.ChecklistNameFilter, RelativeSource={RelativeSource AncestorType=UserControl}, UpdateSourceTrigger=PropertyChanged}" Width="200" ToolTip="Enter a regular expression to filter card names"/>
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTextColumn.HeaderTemplate>
                        </DataGridTextColumn>

                        <DataGridTextColumn Binding="{Binding TotalQuantityOwned}" Width="*">
                            <DataGridTextColumn.HeaderTemplate>
                                <DataTemplate>
                                    <StackPanel>
                                        <TextBlock Text="Total Qty"/>
                                        <ComboBox Width="120"
                                                  SelectedValuePath="Content"
                                                  SelectedValue="{Binding DataContext.ChecklistQtyFilter, RelativeSource={RelativeSource AncestorType=UserControl}, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}">
                                            <ComboBoxItem Content="Both" />
                                            <ComboBoxItem Content="Owned" />
                                            <ComboBoxItem Content="Unowned" />
                                        </ComboBox>
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTextColumn.HeaderTemplate>

                            <DataGridTextColumn.CellStyle>
                                <Style TargetType="DataGridCell" BasedOn="{StaticResource {x:Type DataGridCell}}">
                                    <Setter Property="Background" Value="Transparent"/>
                                    <Style.Triggers>
                                        <!-- Use the combined-count aware converter that compares against CopiesNeededForPlayset -->
                                        <DataTrigger Binding="{Binding Converter={StaticResource CombinedCountToCategoryConverter}}" Value="Low">
                                            <Setter Property="Background" Value="{DynamicResource ChecklistLowBrush}"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Converter={StaticResource CombinedCountToCategoryConverter}}" Value="High">
                                            <Setter Property="Background" Value="{DynamicResource ChecklistHighBrush}"/>
                                            <Setter Property="Foreground" Value="{DynamicResource PrimaryBrush}"/>
                                            <Setter Property="FontWeight" Value="SemiBold"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGridTextColumn.CellStyle>
                        </DataGridTextColumn>
                    </DataGrid.Columns>
                </DataGrid>

                <!-- Overlay message shown while calculating -->
                <TextBlock Text="{Binding DataContext.CalculatingMessage, RelativeSource={RelativeSource AncestorType=UserControl}}"
                           FontSize="16"
                           FontWeight="SemiBold"
                           Foreground="{DynamicResource GoldBrush}"
                           Background="{DynamicResource SurfaceBrush}"
                           Padding="12"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           TextAlignment="Center"
                           TextWrapping="Wrap"
                           MaxWidth="400">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Visibility" Value="Collapsed" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding DataContext.IsCalculating, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
            </Grid>
        </Grid>

        <GridSplitter Grid.Column="1"
                      Width="6"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Stretch"
                      ShowsPreview="True"
                      ResizeDirection="Columns"
                      Cursor="SizeWE"/>

        <controls:CardViewerControl Grid.Column="2"
                                    Margin="8,0,0,0"
                                    DataContext="{Binding CardViewer}"/>
    </Grid>
</UserControl>